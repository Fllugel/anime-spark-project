# Вклад у проєкт: Бізнес-питання на зірчастій схемі

**Автор:** Arii Doroshenko
**Етап:** Business Questions (Extended)

## Огляд

Цей документ описує реалізацію модуля розширених бізнес-питань для аналізу зірчастої схеми даних аніме.
Реалізовано 6 окремих аналітичних запитів, які демонструють використання Spark-операцій різного рівня складності: фільтрація, агрегація, джоїни та віконні функції.

Питання охоплюють ключові можливості Spark SQL і забезпечують приклад комплексного аналізу великих датасетів.

---

## Що було реалізовано

### **1. Пошук аніме студії Sunrise з Avg_Score > 8.5**

**Модуль:** `business_questions_extended.py`
**Функція:** `question_1_arii_sunrise()`

**Опис:**
Знайти всі аніме студії *Sunrise*, середній рейтинг яких вищий за 8.5.

**Операції Spark:**

* `FILTER` — фільтрація за студією та рейтингом
* `CAST` — приведення типів
* `ORDER BY` — сортування за рейтингом та популярністю

**Результат:** Список найрейтинговіших робіт студії Sunrise.

---

### **2. Нові користувачі з USA після 2022-01-01**

**Функція:** `question_2_arii_users_usa_recent()`

**Опис:**
Отримання списку користувачів із США, що приєдналися після 1 січня 2022 року.

**Spark-техніки:**

* `FILTER` — дата та локація
* `to_date()` — перетворення рядків у дати
* `ORDER BY` — сортування за датою

**Результат:** Група нових активних користувачів для побудови подальших сегментів.

---

### **3. Кількість аніме з рейтингом R-17+ і менше ніж 10 епізодів**

**Функція:** `question_3_arii_r17_lt10()`

**Опис:**
Порахувати всі тайтли вікового рейтингу *R-17+*, що мають менше ніж 10 епізодів.

**Spark-техніки:**

* `FILTER` — віковий рейтинг та число епізодів
* `COUNT` — підрахунок збігів

**Результат:** DataFrame з однією числовою метрикою — кількістю таких тайтлів.

---

### **4. Користувачі, які поставили оцінку 10 для «Cowboy Bebop»**

**Функція:** `question_4_arii_cowboy10()`

**Опис:**
Знайти всіх користувачів, які оцінили «Cowboy Bebop» на 10 балів, і вивести їхні імена разом з інформацією про аніме.

**Spark-техніки:**

* `JOIN` між `Fact_UserRatings`, `Dim_Anime`, `Dim_User`
* `FILTER` за оцінкою
* `DISTINCT` — уникнення дублікатів
* `ORDER BY` — сортування за іменем користувача

**Результат:** Список “фанатів” Cowboy Bebop.

---

### **5. Середня оцінка по кожному жанру**

**Функція:** `question_5_arii_avg_by_genre()`

**Опис:**
Порахувати середній рейтинг користувачів для кожного жанру аніме.
Оскільки жанри зберігаються у вигляді comma-separated рядка, вони були розкладені на окремі записи.

**Spark-техніки:**

* `JOIN` із таблицею аніме
* `SPLIT` → `EXPLODE` — розбиття жанрів
* `TRIM` — очистка
* `GROUP BY` жанру
* `AVG`, `COUNT` — агрегації
* `ORDER BY` — сортування за середнім рейтингом

**Результат:** Таблиця жанрів із середньою оцінкою та кількістю поставлених рейтингів.

---

### **6. Ранжування аніме всередині типу (TV/Movie/OVA/…)**

**Функція:** `question_6_arii_rank_within_type()`

**Опис:**
Для кожного *Type* аніме обчислено ранг на основі `Avg_Score` (за спаданням).

**Spark-техніки:**

* `Window.partitionBy(Type).orderBy(Avg_Score)`
* `row_number()` — формування рангу
* `FILTER` — виключення null значень

**Результат:** Список аніме з місцем у своєму типі.

---

## Збереження результатів

Усі результати кожного запиту зберігаються у форматі CSV у директорії:

```
results/arii_extended/
```

Запис виконується з використанням:

* `coalesce(1)` — для створення одного файлу
* `write.csv(mode="overwrite")` — перезапис результатів

---

## Технічні деталі

### Використані Spark-операції:

* **FILTER** — фільтрація за умовами
* **JOIN** — об’єднання таблиць фактів та вимірів
* **GROUP BY** — агрегація по категоріях
* **AGGREGATION** — `AVG`, `COUNT`
* **WINDOW FUNCTIONS** — `row_number()`
* **STRING OPERATIONS** — робота з жанрами (split/explode)

### Обробка даних:

* Приведення типів (особливо рейтингів)
* Робота з null значеннями
* Обробка COMMA-separated жанрів
* Валідація даних перед агрегацією


Запуск модуля здійснюється функцією:
```
run_arii_extended_questions()
```

---

## Висновки

Було реалізовано 6 бізнес-питань, які демонструють:

1. Аналіз метаданих аніме на основі рейтингу та жанрових характеристик.
2. Аналітику користувацької активності (країна, дата реєстрації, улюблені тайтли).
3. Використання повного набору Spark SQL можливостей — від простих фільтрів до віконних функцій.
4. Коректну інтеграцію з наявною зірчастою схемою та можливість експорту результатів.