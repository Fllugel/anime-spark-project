# Вклад у проект: Етап трансформації (Бізнес-питання)

**Автор:** Zhukovskyi Artem  
**Етап:** Transformation Stage

## Огляд

Цей документ описує реалізацію 6 бізнес-питань для аналізу даних аніме. Реалізація базується на зірчастій схемі даних та використовує різні можливості PySpark SQL, включаючи фільтрацію, об'єднання таблиць (JOIN), агрегацію (GROUP BY) та віконні функції.

## Реалізовані бізнес-питання

Всі питання реалізовані у модулі `transformation/business_questions.py` та використовують підготовлену зірчасту схему (`Dim_User`, `Dim_Anime`, `Dim_Date`, `Fact_UserRatings`).

### Питання 1 (Filters)
**Опис:** Скільки існує "дуже низьких" оцінок (`Is_Low_Rating = 1`), які були поставлені аніме з менш ніж 1000 учасниками (`Members < 1000`).

**Бізнес-цінність:** Дозволяє виявити, чи схильні користувачі ставити низькі оцінки маловідомим (нішовим) аніме.

**Використані операції:**
- `join`: Об'єднання таблиці фактів оцінок з виміром аніме.
- `filter`: Відбір записів за умовою низького рейтингу та малого кількості учасників.
- `count`: Підрахунок кількості таких випадків.

### Питання 2 (JOIN)
**Опис:** Знайти користувачів, які не поставили жодної "низької оцінки" (`Fact.Is_Low_Rating = 0` для всіх їхніх оцінок).

**Бізнес-цінність:** Ідентифікація лояльних або "добрих" глядачів, які схильні ставити лише позитивні оцінки.

**Використані операції:**
- `join`: Об'єднання таблиці користувачів з таблицею фактів.
- `groupBy`: Групування по користувачах.
- `sum`: Підрахунок кількості низьких оцінок для кожного користувача.
- `filter`: Відбір користувачів, у яких сума низьких оцінок дорівнює 0.

### Питання 3 (GROUP BY)
**Опис:** Визначити 5 найкращих країн (`Dim_User.Location`) за сумарною кількістю "фанатських" оцінок (`SUM(Fact.Is_Above_Average)`).

**Бізнес-цінність:** Визначення географічних регіонів з найбільш активною та позитивно налаштованою аудиторією.

**Використані операції:**
- `join`: Об'єднання таблиці фактів з виміром користувачів.
- `groupBy`: Групування даних за країною.
- `agg (sum)`: Обчислення загальної кількості оцінок вище середнього.
- `orderBy`: Сортування за спаданням для визначення топу.
- `limit`: Вибір топ-5 результатів.

### Питання 4 (Window Functions - AVG)
**Опис:** Для кожної окремої оцінки показати відхилення цієї оцінки від середньої оцінки *цього* користувача.

**Бізнес-цінність:** Допомагає зрозуміти, наскільки конкретна оцінка відрізняється від типової поведінки користувача (чи це аномально висока/низька оцінка для нього).

**Використані операції:**
- `Window.partitionBy`: Визначення вікна для кожного користувача.
- `avg`: Обчислення середньої оцінки в межах вікна (користувача).
- `withColumn`: Додавання стовпця з різницею між поточною оцінкою та середнім значенням.

### Питання 5 (Window Functions - LEAD/LAG)
**Опис:** Показати список аніме, відсортований за рангом популярності, і вивести різницю (розрив) у популярності між поточним аніме і наступним.

**Бізнес-цінність:** Аналіз щільності конкуренції між аніме у рейтингу популярності. Виявлення значних розривів між позиціями.

**Використані операції:**
- `Window.orderBy`: Сортування вікна за рангом популярності.
- `lead`: Отримання значення популярності наступного аніме в списку.
- Обчислення різниці між поточною та наступною популярністю.

### Питання 6 (Window Functions - COUNT)
**Опис:** Для кожного користувача показати його загальну кількість оцінок поруч з кожною його індивідуальною оцінкою.

**Бізнес-цінність:** Збагачення даних про окрему оцінку контекстом активності користувача (чи це оцінка від новачка з 1 оцінкою, чи від досвідченого глядача).

**Використані операції:**
- `Window.partitionBy`: Групування вікна по користувачах.
- `count`: Підрахунок загальної кількості записів у вікні (всього оцінок користувача).
- `select`: Вибірка необхідних полів разом з обчисленим лічильником.

## Технічні деталі

- **Модульність:** Код організовано у вигляді окремих функцій для кожного питання, що дозволяє легко розширювати список питань іншим членам команди.
- **Збереження результатів:** Результати кожного запиту зберігаються у форматі CSV у директорію `data/results/business_questions/`.
- **Оптимізація:** Використано `coalesce(1)` для запису результатів у один файл для зручності перегляду.

